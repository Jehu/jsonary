<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Initial Facebook UI demo</title>
		<link rel="stylesheet" href="../../renderers/plain.jsonary.css">
		<link rel="stylesheet" href="fb-ui-user.css">
		<meta name="viewport" content="width=960">
	</head>
	<body>
		<div id="main"></div>
		<script src="../../jsonary.js"></script>
		<script src="../../plugins/jsonary.hash.js"></script>
		<script src="../../renderers/plain.jsonary.js"></script>
		<script src="fb-ui-user.js"></script>
		<script>
			// Facebook auth
			function forwardToFacebook() {
				var facebookAppId = 219375971524697;
				var facebookRedirectUri = window.location;
				var facebookPermissions = ["user_about_me", "friends_about_me", "user_groups", "user_likes", "friends_groups", "friends_likes", "user_relationships", "friends_relationships", "user_status", "friends_status", "user_website", "friends_website", "read_stream", "publish_stream", "manage_notifications"];
				var facebookAuthUrl = "https://www.facebook.com/dialog/oauth?client_id=" + facebookAppId + "&redirect_uri=" + encodeURIComponent(facebookRedirectUri) + "&response_type=token&scope=" + facebookPermissions.join(",");
				window.location.replace(facebookAuthUrl);
			}

			var mainElement = document.getElementById("main");
			var currentUrl = null;
			var currentData = null;
			var prefix = "https://graph.facebook.com";
			function renderToMain(url, data) {
				mainElement.innerHTML = "Loading schemas...";
				currentUrl = url;
				currentData = data;
				Jsonary.hash.property("page").setValue(currentUrl.substring(prefix.length));
				data.whenSchemasStable(function () {
					if (currentData == data) {
						Jsonary.render(mainElement, data);
					}
				});
			}

			var authToken = Jsonary.hash.propertyValue("access_token");
			if (authToken == undefined) {
				mainElement.innerHTML = '<a href="javascript:forwardToFacebook()">Authorise with Facebook</a>';
			} else {
				// Add access token to all outgoing requests
				Jsonary.addLinkPreHandler(function(link, data) {
					if (authToken != null) {
						if (data.basicType() == undefined) {
							data.setValue({access_token: authToken});
						} else if (data.basicType() == "object") {
							data.property("access_token").setValue(authToken);
						}
					}
				});
				Jsonary.hash.removeProperty("access_token").removeProperty("expires_in");

				// When the fragment changes, get the page URL from it, and fetch/render it if needed
				Jsonary.hash.onChange(function (hash) {
					// default to the user's profile
					if (!hash.property("page").defined()) {
						hash.property("page").setValue("/me");
					}
					var hashUrl = prefix + hash.propertyValue("page");
					if (hashUrl == currentUrl) {
						// page URL is what we think it should be
						return; 
					}
					currentUrl = hashUrl;
					// The Facebook Graph API doesn't provide JSON Schema documentation, so we're adding our own
					var schemaHint = null;
					if (hashUrl == prefix + "/me") {
						schemaHint = "../schemas/me.json";
					} else {
						schemaHint = "../schemas/guess.json";
					}
					// Fetch the URL specified by the hash, and 
					Jsonary.getData({
						url: hashUrl,
						data: {access_token: authToken}
					}, function (data) {
						renderToMain(hashUrl, data);
					}, schemaHint);
				});
			}

			// Any link that isn't otherwise handled is rendered in the main element
			Jsonary.addLinkHandler(function (link, submissionData, request) {
				mainElement.innerHTML = "Loading: " + link.href;
				
				// Set the current page URL, so when we change it in the fragment, it doesn't recognise it as a change
				currentUrl = link.href;
				Jsonary.hash.addHistoryPoint();
				Jsonary.hash.property("page").setValue(link.href.substring(prefix.length));

				request.getData(function (data) {
					if (data.schemas().length == 0) {
						// No schema hint supplied - have a guess
						data.addSchema("../schemas/guess.json");
					}
					renderToMain(link.href, data);
				});
			});
		</script>
	</body>
</html>
