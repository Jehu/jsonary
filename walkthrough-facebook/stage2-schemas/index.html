<html>
  <head>
		<title>Adding Schemas</title>
		<link rel="stylesheet" href="../../css/main.css">
		<meta name="viewport" content="width=960">
	</head>
	<body>
		<script src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>
		<div align="center">
			<div id="content">
				<h1>Adding Schemas</h1>
				<div class="tagline">describing the Graph API</div>

				<div id="nav">
					back to
					<a class="nav-link" href="../../">main page</a>
					<a class="nav-link" href="../">Facebook walkthrough</a>
				</div>
				
				<div class="resource-list">
					The demos on this page use the following files:
					<ul>
						<li><span class="filename">jsonary.js</span> - the core Jsonary library
						<li><span class="filename">jsonary.hash.js</span> - the Jsonary.Hash plugin
						<li><span class="filename">basic.jsonary.js</span> - a default set of renderers, that look similar to plain JSON
						<li><span class="filename">basic.jsonary.css</span> - the stylesheet used by the above renderers
					</ul>
				</div>
	
				<h2>Why are we doing this?</h2>
				<div class="section">
					<p>Ideally, we would be working with an API that is already documented using JSON Schemas, and sending out links to those schemas in the HTTP header.
					<p>Sadly, that is not currently the case for the Facebook Graph API.  However, we can write our <em>own</em> schemas describing the API, and match them up afterwards.
				</div>

				<h2>Adding a "current user" schema</h2>
				<div class="section">
					<p>OK, first we create a schema describing the data we expect from <code>https://graph.facebook.com/me</code>.
<pre class="example code">
{
	"title": "Current user"
}
</pre>
					<p>Then, we use the "schema hint" argument of <code>Jsonary.getData()</code>.
<pre class="example code">
var mainElement = document.getElementById("main");
function renderToMain(data) {
	Jsonary.render(mainElement, data);
}

Jsonary.getData({
	url: "https://graph.facebook.com/me",
	data: {access_token: authToken}
}, function (data) {
	renderToMain(data);
}, <B>"schemas/me.json"</B>);
</pre>
					<p>You can see that in action <a href="fb-schema-me.html" target="facebookSchemaMe">here</a>.  As you can hopefully see, the data displayed about the current user is associated with a schema titled "Current user".
				</div>

				<h2>Handling links</h2>
				<div class="section">
					<p>In the example above, the "me" schema defines some links.
					<p>Not only does nothing happen when you click the links, but Jsonary doesn't know to include the OAuth token in the requests it makes, so it doesn't even get the correct data back.
					<p>We solve the second problem by adding a link pre-handler that attaches the OAuth token to the submitted data:
<pre class="example code">
// Add access token to all outgoing requests
Jsonary.addLinkPreHandler(function(link, data) {
	if (accessToken != null) {
		if (data.basicType() == undefined) {
			data.setValue({access_token: accessToken});
		} else if (data.basicType() == "object") {
			data.property("access_token").setValue(accessToken);
		}
	}
});
</pre>
					<p>The first problem, we solve by rendering the result in the main element:
<pre class="example code">
// Any link that isn't otherwise handled is rendered in the main element
Jsonary.addLinkHandler(function (link, submissionData, request) {
	mainElement.innerHTML = "Loading: " + link.href;
	request.getData(function (data) {
		renderToMain(data);
	});
});
</pre>
					<p>We also do a bit of fancy jiggery-pokery with the Jsonary.Hash plugin, storing a URL in the URI fragment, and checking the result to see if we should be rendering anything.
					<p>You can see all that in action <a href="fb-schema-me-2.html" target="facebookSchemaMe2">here</a> - have a read through the code!
				</div>

				<h2>More documentation</h2>
				<div class="section">
					<p>The next stage is to provide schemas for the rest of the API.
					<p>I haven't documented the complete Facebook API, only some of it.  However, you can see the result <a href="fb-schema-full.html" target="facebookSchemaFull">here</a>.
				</div>
			</div>
		</div>
	</body>
</html>
